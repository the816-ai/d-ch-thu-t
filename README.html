<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Dá»‹ch Thuáº­t - OpenAI API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .main-container {
            width: 100%;
            max-width: 900px;
            display: flex;
            gap: 20px;
            height: 700px;
        }

        .setup-panel {
            width: 350px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .setup-header {
            background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .setup-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .setup-content {
            padding: 25px;
            flex: 1;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #10a37f;
        }

        .form-select {
            cursor: pointer;
        }

        .api-button {
            width: 100%;
            background: #10a37f;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .api-button:hover {
            background: #0d8f6c;
            transform: translateY(-1px);
        }

        .api-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            margin-bottom: 15px;
        }

        .status-disconnected {
            background: #fee;
            color: #c53030;
            border: 1px solid #fed7d7;
        }

        .status-connected {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #c6f6d5;
        }

        .status-testing {
            background: #fefcbf;
            color: #744210;
            border: 1px solid #faf089;
        }

        .info-box {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-box h4 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box p {
            color: #4a5568;
            font-size: 13px;
            line-height: 1.5;
        }

        .api-guide {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .chatbot-container {
            flex: 1;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .chatbot-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .chatbot-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .ai-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.user .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.bot {
            align-items: flex-start;
        }

        .message.bot .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .openai-result {
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
            border-left: 4px solid #10a37f;
            padding: 16px;
            margin-top: 12px;
            border-radius: 8px;
        }

        .result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-label {
            font-weight: 600;
            color: #10a37f;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-badge-small {
            background: #10a37f;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
        }

        .translation-text {
            color: #2d3748;
            font-size: 16px;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .context-explanation {
            background: rgba(16, 163, 127, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 13px;
            color: #2d3748;
        }

        .result-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-top: 10px;
        }

        .model-info {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 500;
        }

        .chat-input-container {
            background: white;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }

        .language-selector {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .language-selector:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 15px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            align-items: flex-start;
        }

        .typing-bubble {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            border-bottom-left-radius: 6px;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #10a37f;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .welcome-message {
            text-align: center;
            color: #666;
            padding: 20px;
            border-radius: 12px;
            background: #fff;
            border: 2px dashed #e9ecef;
        }

        .api-required {
            background: #fef5e7;
            border: 2px dashed #f6ad55;
            color: #c05621;
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar,
        .setup-content::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .setup-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .setup-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .setup-panel {
                width: 100%;
                order: 2;
            }
            
            .chatbot-container {
                order: 1;
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Setup Panel -->
        <div class="setup-panel">
            <div class="setup-header">
                <div class="setup-title">
                    ğŸ”§ Cáº¥u hÃ¬nh OpenAI API
                </div>
                <div style="font-size: 12px; opacity: 0.9;">
                    Äá»™ chÃ­nh xÃ¡c cao nháº¥t
                </div>
            </div>
            
            <div class="setup-content">
                <div class="info-box">
                    <h4>ğŸ¯ Lá»£i Ã­ch OpenAI API:</h4>
                    <p>â€¢ Äá»™ chÃ­nh xÃ¡c 98%+ cho má»i ngÃ´n ngá»¯<br>
                    â€¢ Hiá»ƒu ngá»¯ cáº£nh vÃ  sáº¯c thÃ¡i<br>
                    â€¢ Dá»‹ch thuáº­t ngá»¯ chuyÃªn ngÃ nh<br>
                    â€¢ Giá»¯ nguyÃªn format vÃ  Ã½ nghÄ©a</p>
                </div>

                <div class="form-group">
                    <label class="form-label">OpenAI API Key:</label>
                    <input type="password" 
                           class="form-input" 
                           id="apiKey" 
                           placeholder="sk-...">
                    <div class="api-guide">
                        Láº¥y API key táº¡i: <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Model:</label>
                    <select class="form-input form-select" id="modelSelect">
                        <option value="gpt-4">GPT-4 (Cháº¥t lÆ°á»£ng cao nháº¥t)</option>
                        <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo (Nhanh & Tá»‘t)</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo (CÃ¢n báº±ng)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Äá»™ sÃ¡ng táº¡o (Temperature):</label>
                    <input type="range" 
                           class="form-input" 
                           id="temperature" 
                           min="0" 
                           max="1" 
                           step="0.1" 
                           value="0.3">
                    <div class="api-guide">
                        0.0 = ChÃ­nh xÃ¡c nháº¥t, 1.0 = SÃ¡ng táº¡o nháº¥t
                    </div>
                </div>

                <button class="api-button" id="testButton" onclick="testAPI()">
                    ğŸ§ª Test API Connection
                </button>

                <div class="status-indicator status-disconnected" id="apiStatus">
                    âŒ ChÆ°a káº¿t ná»‘i API
                </div>

                <div class="info-box">
                    <h4>ğŸ’° Chi phÃ­ Æ°á»›c tÃ­nh:</h4>
                    <p><strong>GPT-3.5:</strong> ~$0.002/1000 tokens<br>
                    <strong>GPT-4:</strong> ~$0.03/1000 tokens<br>
                    <em>1 cÃ¢u tiáº¿ng Nháº­t â‰ˆ 10-20 tokens</em></p>
                </div>

                <div class="info-box">
                    <h4>ğŸ“‹ HÆ°á»›ng dáº«n láº¥y API Key:</h4>
                    <p>1. ÄÄƒng kÃ½ táº¡i platform.openai.com<br>
                    2. VÃ o API Keys â†’ Create new<br>
                    3. Copy key vÃ  paste vÃ o Ã´ trÃªn<br>
                    4. Náº¡p credit (tá»‘i thiá»ƒu $5)</p>
                </div>
            </div>
        </div>

        <!-- Chatbot Container -->
        <div class="chatbot-container">
            <div class="chatbot-header">
                <div class="chatbot-title">
                    ğŸ¤– AI Translation Assistant
                    <span class="ai-badge">OpenAI Powered</span>
                </div>
                <div class="chatbot-subtitle">
                    Dá»‹ch thuáº­t chÃ­nh xÃ¡c vá»›i trÃ­ tuá»‡ nhÃ¢n táº¡o
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message api-required">
                    <h3>ğŸ”‘ Cáº§n cáº¥u hÃ¬nh OpenAI API</h3>
                    <p>Vui lÃ²ng nháº­p API key á»Ÿ panel bÃªn trÃ¡i Ä‘á»ƒ báº¯t Ä‘áº§u sá»­ dá»¥ng dá»‹ch thuáº­t AI vá»›i Ä‘á»™ chÃ­nh xÃ¡c cao nháº¥t.</p>
                </div>
            </div>

            <div class="message typing-indicator" id="typingIndicator">
                <div class="typing-bubble">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <select class="language-selector" id="languageDirection">
                    <option value="ja-vi">ğŸ‡¯ğŸ‡µ Tiáº¿ng Nháº­t â†’ ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                    <option value="vi-ja">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t â†’ ğŸ‡¯ğŸ‡µ Tiáº¿ng Nháº­t</option>
                    <option value="en-vi">ğŸ‡ºğŸ‡¸ Tiáº¿ng Anh â†’ ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                    <option value="vi-en">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t â†’ ğŸ‡ºğŸ‡¸ Tiáº¿ng Anh</option>
                    <option value="zh-vi">ğŸ‡¨ğŸ‡³ Tiáº¿ng Trung â†’ ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                    <option value="vi-zh">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t â†’ ğŸ‡¨ğŸ‡³ Tiáº¿ng Trung</option>
                </select>
                
                <div class="input-row">
                    <textarea class="message-input" 
                             id="messageInput" 
                             placeholder="Nháº­p vÄƒn báº£n cáº§n dá»‹ch..." 
                             rows="1"
                             disabled></textarea>
                    <button class="send-button" 
                           id="sendButton" 
                           onclick="sendMessage()"
                           disabled>
                        â¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let apiKey = '';
        let isConnected = false;
        let currentModel = 'gpt-3.5-turbo';
        let temperature = 0.3;

        // System prompts for different contexts
        const systemPrompts = {
            'ja-vi': `Báº¡n lÃ  má»™t chuyÃªn gia dá»‹ch thuáº­t tá»« tiáº¿ng Nháº­t sang tiáº¿ng Viá»‡t. 
            HÃ£y dá»‹ch chÃ­nh xÃ¡c, giá»¯ nguyÃªn Ã½ nghÄ©a vÃ  ngá»¯ cáº£nh. 
            Äá»‘i vá»›i thuáº­t ngá»¯ ká»¹ thuáº­t, hÃ£y giáº£i thÃ­ch ngáº¯n gá»n trong ngoáº·c Ä‘Æ¡n náº¿u cáº§n.
            Giá»¯ nguyÃªn tÃªn riÃªng, thÆ°Æ¡ng hiá»‡u, vÃ  mÃ£ code.`,
            
            'vi-ja': `ã‚ãªãŸã¯æ—¥æœ¬èªç¿»è¨³ã®å°‚é–€å®¶ã§ã™ã€‚ãƒ™ãƒˆãƒŠãƒ èªã‹ã‚‰æ—¥æœ¬èªã«æ­£ç¢ºã«ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚
            æ„å‘³ã¨æ–‡è„ˆã‚’ä¿æŒã—ã€æŠ€è¡“ç”¨èªã«ã¤ã„ã¦ã¯å¿…è¦ã«å¿œã˜ã¦æ‹¬å¼§å†…ã§ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
            å›ºæœ‰åè©ã€ãƒ–ãƒ©ãƒ³ãƒ‰åã€ã‚³ãƒ¼ãƒ‰ã¯ãã®ã¾ã¾ä¿æŒã—ã¦ãã ã•ã„ã€‚`,
            
            'en-vi': `Báº¡n lÃ  chuyÃªn gia dá»‹ch thuáº­t tá»« tiáº¿ng Anh sang tiáº¿ng Viá»‡t.
            Dá»‹ch chÃ­nh xÃ¡c, tá»± nhiÃªn, phÃ¹ há»£p vá»›i vÄƒn hÃ³a Viá»‡t Nam.
            Giá»¯ nguyÃªn thuáº­t ngá»¯ ká»¹ thuáº­t vÃ  tÃªn riÃªng.`,
            
            'vi-en': `You are an expert translator from Vietnamese to English.
            Translate accurately while maintaining natural English flow.
            Preserve technical terms and proper nouns.`,
            
            'zh-vi': `Báº¡n lÃ  chuyÃªn gia dá»‹ch thuáº­t tá»« tiáº¿ng Trung sang tiáº¿ng Viá»‡t.
            Dá»‹ch chÃ­nh xÃ¡c, tá»± nhiÃªn, phÃ¹ há»£p vá»›i ngá»¯ cáº£nh.
            Giá»¯ nguyÃªn tÃªn riÃªng vÃ  thuáº­t ngá»¯ chuyÃªn mÃ´n.`,
            
            'vi-zh': `æ‚¨æ˜¯è¶Šå—è¯­åˆ°ä¸­æ–‡çš„ç¿»è¯‘ä¸“å®¶ã€‚
            è¯·å‡†ç¡®ç¿»è¯‘ï¼Œä¿æŒè‡ªç„¶çš„ä¸­æ–‡è¡¨è¾¾ã€‚
            ä¿ç•™ä¸“æœ‰åè¯å’ŒæŠ€æœ¯æœ¯è¯­ã€‚`
        };

        // API Functions
        async function testAPI() {
            const apiKeyInput = document.getElementById('apiKey');
            const testButton = document.getElementById('testButton');
            const statusDiv = document.getElementById('apiStatus');
            
            apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                showStatus('âŒ Vui lÃ²ng nháº­p API key', 'error');
                return;
            }
            
            testButton.disabled = true;
            testButton.textContent = 'ğŸ”„ Äang kiá»ƒm tra...';
            showStatus('ğŸ”„ Äang kiá»ƒm tra káº¿t ná»‘i...', 'testing');
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'user',
                                content: 'Test connection'
                            }
                        ],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    isConnected = true;
                    showStatus('âœ… Káº¿t ná»‘i thÃ nh cÃ´ng!', 'success');
                    enableChat();
                    updateWelcomeMessage();
                } else {
                    const error = await response.json();
                    showStatus(`âŒ Lá»—i: ${error.error?.message || 'API key khÃ´ng há»£p lá»‡'}`, 'error');
                }
            } catch (error) {
                showStatus(`âŒ Lá»—i káº¿t ná»‘i: ${error.message}`, 'error');
            }
            
            testButton.disabled = false;
            testButton.textContent = 'ğŸ§ª Test API Connection';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status-indicator status-${type}`;
        }

        function enableChat() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').placeholder = 'Nháº­p vÄƒn báº£n cáº§n dá»‹ch...';
        }

        function updateWelcomeMessage() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <h3>ğŸ‰ Sáºµn sÃ ng dá»‹ch thuáº­t! ğŸ‰</h3>
                    <p>OpenAI API Ä‘Ã£ Ä‘Æ°á»£c káº¿t ná»‘i thÃ nh cÃ´ng.<br>
                    Báº¡n cÃ³ thá»ƒ báº¯t Ä‘áº§u dá»‹ch vá»›i Ä‘á»™ chÃ­nh xÃ¡c cao nháº¥t.</p>
                    <div style="margin-top: 15px; font-size: 14px; color: #666;">
                        <strong>Model:</strong> ${currentModel}<br>
                        <strong>Há»— trá»£:</strong> Nháº­t, Viá»‡t, Anh, Trung<br>
                        <strong>TÃ­nh nÄƒng:</strong> Hiá»ƒu ngá»¯ cáº£nh, giá»¯ format
                    </div>
                </div>
            `;
        }

        // Translation function
        async function translateWithOpenAI(text, direction) {
            const model = document.getElementById('modelSelect').value;
            const temp = parseFloat(document.getElementById('temperature').value);
            
            const systemPrompt = systemPrompts[direction];
            const userPrompt = `Dá»‹ch vÄƒn báº£n sau:\n\n"${text}"`;
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: 'system',
                                content: systemPrompt
                            },
                            {
                                role: 'user', 
                                content: userPrompt
                            }
                        ],
                        temperature: temp,
                        max_tokens: 1000
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API Error');
                }
                
                const data = await response.json();
                const translation = data.choices[0].message.content.trim();
                
                return {
                    translation: translation,
                    model: model,
                    usage: data.usage,
                    finishReason: data.choices[0].finish_reason
                };
                
            } catch (error) {
                throw new Error(`OpenAI API Error: ${error.message}`);
            }
        }

        // UI Functions
        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}`;
            
            const bubbleEl = document.createElement('div');
            bubbleEl.className = 'message-bubble';
            bubbleEl.textContent = content;
            
            messageEl.appendChild(bubbleEl);
            messagesContainer.appendChild(messageEl);
            scrollToBottom();
        }

        function addOpenAIResult(original, result, direction) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message bot';
            
            const bubbleEl = document.createElement('div');
            bubbleEl.className = 'message-bubble';
            
            // Calculate cost estimate
            const costPer1k = result.model.includes('gpt-4') ? 0.03 : 0.002;
            const cost = ((result.usage?.total_tokens || 0) / 1000 * costPer1k).toFixed(4);
            
            bubbleEl.innerHTML = `
                <div class="openai-result">
                    <div class="result-header">
                        <div class="result-label">
                            ğŸ¤– Báº£n dá»‹ch AI
                            <span class="ai-badge-small">OpenAI</span>
                        </div>
                    </div>
                    
                    <div class="translation-text">
                        ${result.translation}
                    </div>
                    
                    ${result.translation.includes('(') ? `
                    <div class="context-explanation">
                        ğŸ’¡ AI Ä‘Ã£ thÃªm giáº£i thÃ­ch ngá»¯ cáº£nh Ä‘á»ƒ dá»‹ch chÃ­nh xÃ¡c hÆ¡n
                    </div>
                    ` : ''}
                    
                    <div class="result-meta">
                        <span class="model-info">${result.model}</span>
                        <span>Tokens: ${result.usage?.total_tokens || 'N/A'}</span>
                        <span>Cost: ~$${cost}</span>
                    </div>
                </div>
            `;
            
            messageEl.appendChild(bubbleEl);
            messagesContainer.appendChild(messageEl);
            scrollToBottom();
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'flex';
            scrollToBottom();
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Main send message function
        async function sendMessage() {
            if (!isConnected) {
                alert('Vui lÃ²ng káº¿t ná»‘i OpenAI API trÆ°á»›c!');
                return;
            }

            const input = document.getElementById('messageInput');
            const direction = document.getElementById('languageDirection').value;
            const text = input.value.trim();
            
            if (!text) return;
            
            // Add user message
            addMessage(text, 'user');
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('sendButton').disabled = true;
            
            // Show typing indicator
            showTyping();
            
            try {
                // Call OpenAI API
                const result = await translateWithOpenAI(text, direction);
                
                // Hide typing and show result
                hideTyping();
                addOpenAIResult(text, result, direction);
                
            } catch (error) {
                hideTyping();
                addMessage(`âŒ Lá»—i dá»‹ch thuáº­t: ${error.message}`, 'bot');
            }
            
            // Re-enable send button
            document.getElementById('sendButton').disabled = false;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const modelSelect = document.getElementById('modelSelect');
            const temperatureSlider = document.getElementById('temperature');
            
            // Enter key to send
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (isConnected && this.value.trim()) {
                        sendMessage();
                    }
                }
            });
            
            // Auto-resize textarea
            input.addEventListener('input', function() {
                autoResizeTextarea();
                if (isConnected) {
                    sendButton.disabled = !this.value.trim();
                }
            });
            
            // Model selection change
            modelSelect.addEventListener('change', function() {
                currentModel = this.value;
                if (isConnected) {
                    addMessage(`ğŸ“ ÄÃ£ chuyá»ƒn sang model: ${this.value}`, 'bot');
                }
            });
            
            // Temperature change
            temperatureSlider.addEventListener('input', function() {
                temperature = parseFloat(this.value);
                const label = this.nextElementSibling;
                if (label) {
                    label.textContent = `${this.value} - ${this.value < 0.3 ? 'ChÃ­nh xÃ¡c' : this.value < 0.7 ? 'CÃ¢n báº±ng' : 'SÃ¡ng táº¡o'}`;
                }
            });
            
            // API key enter to test
            document.getElementById('apiKey').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    testAPI();
                }
            });
            
            // Initial state
            sendButton.disabled = true;
        });

        // Sample phrases for quick testing
        const samplePhrases = {
            'ja-vi': [
                'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                'ãŠå®¢æ§˜ã‚µãƒãƒ¼ãƒˆã«ãŠå•ã„åˆã‚ã›ãã ã•ã„', 
                'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã‚’æ›´æ–°ã—ã¦ãã ã•ã„',
                'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ',
                'ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸ'
            ],
            'vi-ja': [
                'ÄÃ£ xáº£y ra lá»—i há»‡ thá»‘ng',
                'Vui lÃ²ng liÃªn há»‡ bá»™ pháº­n há»— trá»£',
                'Cáº­p nháº­t cÃ i Ä‘áº·t tÃ i khoáº£n',
                'ÄÄƒng nháº­p tháº¥t báº¡i', 
                'LÆ°u dá»¯ liá»‡u thÃ nh cÃ´ng'
            ],
            'en-vi': [
                'System maintenance in progress',
                'Please contact customer support',
                'Your account has been updated',
                'Authentication failed',
                'Data backup completed'
            ],
            'vi-en': [
                'Há»‡ thá»‘ng Ä‘ang báº£o trÃ¬',
                'Vui lÃ²ng liÃªn há»‡ há»— trá»£ khÃ¡ch hÃ ng',
                'TÃ i khoáº£n Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t',
                'XÃ¡c thá»±c tháº¥t báº¡i',
                'Sao lÆ°u dá»¯ liá»‡u hoÃ n táº¥t'
            ]
        };

        // Function to add sample phrase
        function useSamplePhrase(phrase) {
            if (isConnected) {
                const input = document.getElementById('messageInput');
                input.value = phrase;
                input.focus();
                autoResizeTextarea();
                document.getElementById('sendButton').disabled = false;
            }
        }

        // Add sample phrases to welcome message after API connection
        function addSamplePhrases() {
            const direction = document.getElementById('languageDirection').value;
            const phrases = samplePhrases[direction] || [];
            
            if (phrases.length > 0 && isConnected) {
                const messagesContainer = document.getElementById('chatMessages');
                const sampleEl = document.createElement('div');
                sampleEl.className = 'message bot';
                
                const bubbleEl = document.createElement('div');
                bubbleEl.className = 'message-bubble';
                
                bubbleEl.innerHTML = `
                    <strong>ğŸ’¡ Thá»­ cÃ¡c cÃ¢u máº«u:</strong><br><br>
                    ${phrases.slice(0, 3).map(phrase => 
                        `<div style="background: #f0f8ff; padding: 8px; margin: 4px 0; border-radius: 6px; cursor: pointer; font-size: 13px;" 
                              onclick="useSamplePhrase('${phrase}')">
                            ğŸ“ ${phrase}
                        </div>`
                    ).join('')}
                `;
                
                sampleEl.appendChild(bubbleEl);
                messagesContainer.appendChild(sampleEl);
                scrollToBottom();
            }
        }

        // Add sample phrases when language changes
        document.getElementById('languageDirection').addEventListener('change', function() {
            if (isConnected) {
                const direction = this.value;
                const directionNames = {
                    'ja-vi': 'Nháº­t â†’ Viá»‡t',
                    'vi-ja': 'Viá»‡t â†’ Nháº­t', 
                    'en-vi': 'Anh â†’ Viá»‡t',
                    'vi-en': 'Viá»‡t â†’ Anh',
                    'zh-vi': 'Trung â†’ Viá»‡t',
                    'vi-zh': 'Viá»‡t â†’ Trung'
                };
                
                addMessage(`ğŸ”„ ÄÃ£ chuyá»ƒn sang: ${directionNames[direction]}`, 'bot');
                
                setTimeout(() => {
                    addSamplePhrases();
                }, 500);
            }
        });

        // Cost calculator
        function calculateCost(text, model) {
            const approxTokens = text.length * 0.75; // Rough estimation
            const costs = {
                'gpt-3.5-turbo': 0.002,
                'gpt-4': 0.03,
                'gpt-4-turbo': 0.01
            };
            
            const costPer1k = costs[model] || 0.002;
            return (approxTokens / 1000 * costPer1k).toFixed(4);
        }

        // Enhanced error handling
        function handleAPIError(error) {
            let errorMessage = 'ÄÃ£ xáº£y ra lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh';
            
            if (error.message.includes('API key')) {
                errorMessage = 'ğŸ”‘ API key khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n';
            } else if (error.message.includes('quota')) {
                errorMessage = 'ğŸ’³ ÄÃ£ háº¿t quota API. Vui lÃ²ng náº¡p thÃªm credit';
            } else if (error.message.includes('rate limit')) {
                errorMessage = 'âš¡ Äang gá»­i quÃ¡ nhanh. Vui lÃ²ng chá» má»™t chÃºt';
            } else if (error.message.includes('model')) {
                errorMessage = 'ğŸ¤– Model khÃ´ng kháº£ dá»¥ng. Thá»­ model khÃ¡c';
            }
            
            return errorMessage;
        }

        // Advanced settings toggle
        function toggleAdvancedSettings() {
            const advanced = document.getElementById('advancedSettings');
            if (advanced) {
                advanced.style.display = advanced.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Export chat history
        function exportChatHistory() {
            const messages = document.querySelectorAll('.message');
            const history = [];
            
            messages.forEach(msg => {
                const bubble = msg.querySelector('.message-bubble');
                if (bubble) {
                    history.push({
                        type: msg.classList.contains('user') ? 'user' : 'bot',
                        content: bubble.textContent || bubble.innerText,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            const dataStr = JSON.stringify(history, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `chat-history-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Real-time cost tracking
        let totalCost = 0;
        
        function updateCostTracking(usage, model) {
            const costs = {
                'gpt-3.5-turbo': 0.002,
                'gpt-4': 0.03,
                'gpt-4-turbo': 0.01
            };
            
            const cost = (usage.total_tokens / 1000) * (costs[model] || 0.002);
            totalCost += cost;
            
            // Update cost display if exists
            const costDisplay = document.getElementById('costDisplay');
            if (costDisplay) {
                costDisplay.textContent = `Total cost: ${totalCost.toFixed(4)}`;
            }
        }

        // Performance monitoring
        function logPerformance(startTime, endTime, model, tokens) {
            const duration = endTime - startTime;
            console.log(`Translation completed:
                Model: ${model}
                Duration: ${duration}ms
                Tokens: ${tokens}
                Speed: ${(tokens / (duration / 1000)).toFixed(2)} tokens/sec
            `);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + Enter to send
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                if (isConnected) {
                    sendMessage();
                }
            }
            
            // Ctrl + L to clear chat
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                if (confirm('XÃ³a toÃ n bá»™ lá»‹ch sá»­ chat?')) {
                    document.getElementById('chatMessages').innerHTML = '';
                    updateWelcomeMessage();
                }
            }
        });

        // Initialize tooltips and help text
        function initializeHelp() {
            const helpTexts = {
                'temperature': 'Äiá»u chá»‰nh Ä‘á»™ sÃ¡ng táº¡o cá»§a AI. 0.0 = ráº¥t chÃ­nh xÃ¡c, 1.0 = ráº¥t sÃ¡ng táº¡o',
                'model': 'GPT-4 chÃ­nh xÃ¡c hÆ¡n nhÆ°ng cháº­m vÃ  Ä‘áº¯t hÆ¡n GPT-3.5',
                'apiKey': 'Láº¥y tá»« platform.openai.com/api-keys'
            };
            
            Object.entries(helpTexts).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.title = text;
                }
            });
        }

        // Call initialize functions when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeHelp();
            
            // Check if API key is stored locally (optional)
            const storedKey = localStorage.getItem('openai_api_key');
            if (storedKey) {
                document.getElementById('apiKey').value = storedKey;
                // Auto-test if user wants
                if (confirm('TÃ¬m tháº¥y API key Ä‘Ã£ lÆ°u. Test káº¿t ná»‘i ngay?')) {
                    testAPI();
                }
            }
        });

        // Save API key option (with user consent)
        function saveAPIKey() {
            if (isConnected && confirm('LÆ°u API key vÃ o trÃ¬nh duyá»‡t? (Chá»‰ lÆ°u local, khÃ´ng gá»­i Ä‘i Ä‘Ã¢u)')) {
                localStorage.setItem('openai_api_key', apiKey);
                alert('âœ… ÄÃ£ lÆ°u API key!');
            }
        }

        // Global keyboard shortcuts info
        function showKeyboardShortcuts() {
            alert(`âŒ¨ï¸ PhÃ­m táº¯t:
            
Ctrl + Enter: Gá»­i tin nháº¯n
Ctrl + L: XÃ³a chat
Enter (trong Ã´ API): Test káº¿t ná»‘i
Enter (trong Ã´ chat): Gá»­i tin nháº¯n`);
        }
    </script>
</body>
</html>
